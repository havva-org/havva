
/*! Minimal grouped bar chart (CSP self, no deps). Not full Chart.js. */
(function(global){
  function drawGroupedBar(ctx, labels, datasets, opts){
    opts=opts||{};
    var W=ctx.canvas.width, H=ctx.canvas.height, P=40;
    var max=0; datasets.forEach(d=>d.data.forEach(v=>{if(v>max)max=v;})); if(max===0)max=1;
    var groupCount=labels.length, barPerGroup=datasets.length, groupW=(W-2*P)/groupCount, barW=Math.max(8,(groupW*0.8)/barPerGroup);
    // bg
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
    // axes
    ctx.strokeStyle="#444"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(P,10); ctx.lineTo(P,H-P); ctx.lineTo(W-10,H-P); ctx.stroke();
    // y ticks
    ctx.fillStyle="#444"; ctx.font="12px system-ui";
    var ticks=5; for(var i=0;i<=ticks;i++){var y=H-P-(H-P-10)*(i/ticks); var v=(max*i/ticks).toFixed(0); ctx.fillText(v,5,y+4); ctx.strokeStyle="#eee"; ctx.beginPath(); ctx.moveTo(P,y); ctx.lineTo(W-10,y); ctx.stroke();}
    // bars
    var colors=opts.colors||["#111","#F4C430","#6b7280","#1f2937"];
    for(var g=0; g<groupCount; g++){
      for(var b=0;b<barPerGroup;b++){
        var x=P+g*groupW + (groupW*0.1) + b*barW;
        var v=datasets[b].data[g]; var h=(H-P-10)*(v/max);
        ctx.fillStyle=colors[b%colors.length];
        ctx.fillRect(x, H-P-h, barW-2, h);
      }
      // x label
      ctx.fillStyle="#444"; ctx.save(); ctx.translate(P+g*groupW+groupW/2, H-P+14); ctx.rotate(0); ctx.textAlign="center"; ctx.fillText(labels[g],0,0); ctx.restore();
    }
    // legend
    var lx=P, ly=10;
    datasets.forEach(function(ds,i){
      ctx.fillStyle=colors[i%colors.length]; ctx.fillRect(lx,ly,12,12);
      ctx.fillStyle="#222"; ctx.fillText(" "+ds.label, lx+16, ly+11); lx+=100;
    });
  }
  global.HavvaCharts={drawGroupedBar:drawGroupedBar};
})(window);
